<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RULETA INSTAGRAM</title>
<style>
:root{
  --bg:#f1f2f6; --ink:#0b0f19;
  --card:#ffffff; --muted:#5b6676;
  --pointer:#9aa0a6; --accent:#5e57ee;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
.wrap{max-width:980px;margin:22px auto;padding:0 16px}
.card{background:var(--card);border-radius:16px;padding:14px;border:1px solid #e5e7ee;box-shadow:0 6px 22px rgba(0,0,0,.06)}
h1,h2{margin:0 0 10px}
.small{font-size:13px;color:var(--muted)}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;position:relative;z-index:5}
button{appearance:none;border:1px solid #cdd3df;background:#fff;color:#0b0f19;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700;box-shadow:0 3px 10px rgba(0,0,0,.07)}
button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
button.ghost{background:#f6f7fb}
button:disabled{opacity:.6;cursor:not-allowed}
textarea{width:100%;height:220px;background:#f7f8fc;color:#0b0f19;border:1px solid #dbe0ea;border-radius:12px;padding:10px 12px}
.kpi{margin-left:auto;opacity:.92;font-size:13px}
.seg{background:#f2f4fb;border:1px solid #e1e6f1;border-radius:999px;padding:3px;display:flex;gap:6px}
.seg button{background:transparent;border:none;padding:6px 10px;border-radius:999px}
.seg button[aria-pressed="true"]{background:#e7ebfb}
.list{margin-top:8px;display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:6px}
.item{display:flex;align-items:center;gap:8px;background:#f8f9fe;border:1px solid #e7ecf7;border-radius:10px;padding:6px 8px}
.item .tag{font-size:12px;opacity:.85;padding:2px 6px;border-radius:999px;background:#e9eefb}

.canvas-wrap{position:relative;margin:12px auto 8px;max-width:680px;aspect-ratio:1/1}
#wheel{width:100%;height:100%;display:block;filter:drop-shadow(0 10px 24px rgba(0,0,0,.1))}
.pointer{position:absolute;right:-8px;top:50%;transform:translateY(-50%);width:64px;height:46px;pointer-events:none;z-index:3}
.pointer svg{width:100%;height:100%;filter:drop-shadow(0 4px 10px rgba(0,0,0,.2))}
.centerBadge{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:120px;height:120px;border-radius:50%;
  background:#2b2d34; color:#fff; display:grid;place-items:center;font-size:56px;font-weight:900;z-index:2;
  box-shadow:inset 0 0 0 18px rgba(255,255,255,.85), inset 0 0 0 22px #2b2d34, 0 10px 26px rgba(0,0,0,.2);
  cursor:pointer; user-select:none; outline:none; transition:transform .15s ease, box-shadow .2s ease;
}
.centerBadge:hover{ transform:translate(-50%,-50%) scale(1.05);
  box-shadow:inset 0 0 0 18px rgba(255,255,255,.9), inset 0 0 0 22px #2b2d34, 0 12px 30px rgba(0,0,0,.22), 0 0 0 8px rgba(94,87,238,.18);
}
.centerBadge:active{ transform:translate(-50%,-50%) scale(0.98); }
.centerBadge:focus-visible{ box-shadow:inset 0 0 0 18px rgba(255,255,255,.9), 0 0 0 10px rgba(94,87,238,.35); }

.progress{height:8px;background:#edf0f7;border:1px solid #e3e7f2;border-radius:999px;overflow:hidden}
.progress .bar{height:100%;width:0%;background:linear-gradient(90deg,#6b64ff,#b9b5ff)}
.counter{font-size:13px;color:#444;margin-top:6px}

/* Modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;justify-content:center;align-items:center;z-index:1000}
.modal.show{display:flex}
.modal-card{position:relative;background:#fff;border:1px solid #e5e7ee;border-radius:14px;padding:18px 16px;text-align:center;min-width:min(520px,92vw);color:#0b0f19;box-shadow:0 18px 60px rgba(0,0,0,.15)}
.modal-card h3{margin:0 0 6px}
.modal-card .avatar{width:110px;height:110px;border-radius:50%;object-fit:cover;border:4px solid #f0f2f7;box-shadow:0 6px 16px rgba(0,0,0,.15);background:#f3f5f9;margin:8px auto 10px;display:block}
.modal-card .win{font-size:26px;font-weight:800}

/* Fases: UNA visible a la vez */
#setup[aria-hidden="true"], #roulette[aria-hidden="true"]{display:none!important}
</style>
</head>
<body>
<div class="wrap">
  <h1>RULETA INSTAGRAM</h1>

  <!-- FASE 1 -->
  <section id="setup" class="card" aria-hidden="false">
    <h2>1) Configuraci√≥n</h2>
    <p class="small">Pega hasta <b>5,000</b> l√≠neas (una por participante). Repetir una l√≠nea aumenta la probabilidad. Tambi√©n puedes usar <b>xN</b> (ej. Juan x3). Comas, punto y coma y tabs separan dentro de una l√≠nea.</p>
    <textarea id="ta" placeholder="@usuario
usuario
https://www.instagram.com/handle/"></textarea>
    <div class="row" style="margin-top:8px">
      <div class="seg" role="group" aria-label="Duraci√≥n del giro">
        <button type="button" data-sec="2">2s</button>
        <button type="button" data-sec="4" aria-pressed="true">4s</button>
        <button type="button" data-sec="8">8s</button>
      </div>
      <span id="kpi" class="kpi">0 l√≠neas</span>
      <div style="margin-left:auto">
        <button id="preview" class="ghost" type="button">Vista previa</button>
        <button id="next" class="primary" type="button" disabled>Ir a la ruleta ‚Üí</button>
      </div>
    </div>
    <div id="previewList" class="list"></div>
    <p class="small" id="audioHint" style="margin-top:6px">üîà El sonido se activar√° tras tu primer toque/clic o tecla.</p>
  </section>

  <!-- FASE 2 -->
  <section id="roulette" class="card" aria-hidden="true">
    <h2>2) Ruleta</h2>
    <div class="canvas-wrap">
      <div class="pointer" aria-hidden="true">
        <svg viewBox="0 0 100 80" fill="none">
          <path d="M92 40 L62 60 L62 20 Z" fill="var(--pointer)" stroke="#60646b" stroke-width="6" stroke-linejoin="round"/>
        </svg>
      </div>
      <canvas id="wheel"></canvas>
      <div id="centerBtn" class="centerBadge" role="button" tabindex="0" aria-label="Girar">?</div>
    </div>
    <div class="row" style="justify-content:space-between;align-items:center">
      <button id="back" class="ghost" type="button">‚Üê Volver</button>
      <div style="flex:1;max-width:680px">
        <div class="progress"><div class="bar" id="bar"></div></div>
        <div id="lineCounter" class="counter">N√∫mero de comentarios: 0</div>
      </div>
      <button id="spin" class="primary" type="button">Girar</button>
    </div>
  </section>
</div>

<!-- Modal ganador -->
<div id="m" class="modal" role="dialog" aria-modal="true">
  <div class="modal-card">
    <h3>Ganador</h3>
    <img id="avatar" class="avatar" alt="Avatar de Instagram" src="" referrerpolicy="no-referrer" crossorigin="anonymous">
    <div id="win" class="win">Nombre</div>
    <div style="margin-top:10px"><button id="close" type="button" class="ghost">Cerrar</button></div>
  </div>
</div>

<script>
(function(){
// -------- DOM
var setup = document.getElementById('setup');
var roulette = document.getElementById('roulette');
var ta = document.getElementById('ta');
var kpi = document.getElementById('kpi');
var previewList = document.getElementById('previewList');
var next = document.getElementById('next');
var back = document.getElementById('back');
var previewBtn = document.getElementById('preview');
var spinBtn = document.getElementById('spin');
var centerBtn = document.getElementById('centerBtn');
var bar = document.getElementById('bar');
var lineCounter = document.getElementById('lineCounter');
var closeBtn = document.getElementById('close');
var wheel = document.getElementById('wheel');
var ctx = wheel.getContext('2d');
var secBtns = Array.prototype.slice.call(document.querySelectorAll('.seg button'));
var audioHint = document.getElementById('audioHint');
var modal = document.getElementById('m');
var winEl = document.getElementById('win');
var avatarEl = document.getElementById('avatar');

// -------- Estado
var LIMIT = 5000;
var labels = [];
var rotation = 0; // puntero a la derecha
var spinning = false;
var duration = 4000;
var bitmap = null, bitmapSize = 0;
var palette = ['#ff3b30','#34c759','#007aff','#ffcc00'];

// -------- Audio (WebAudio) ‚Äî activaci√≥n compatible iOS
var audioCtx = null;
function ensureAudio(){
  if (audioCtx) return;
  try{
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') audioCtx.resume();
    audioHint.textContent = 'üîà Sonido activado.';
  }catch(e){ audioHint.textContent = '‚ö†Ô∏è El audio no pudo inicializarse en este navegador.'; }
}
['pointerdown','touchstart','click','keydown'].forEach(function(ev){
  document.addEventListener(ev, function arm(){ ensureAudio(); }, {once:true, passive:true});
});

function playTick(vol){
  if(!audioCtx) return;
  var t = audioCtx.currentTime;
  var g = audioCtx.createGain(); g.gain.value = 0; g.connect(audioCtx.destination);
  var o = audioCtx.createOscillator(); o.type='square'; o.frequency.value=1500; o.connect(g);
  g.gain.setValueAtTime(0, t);
  g.gain.linearRampToValueAtTime(0.18*(vol||1), t+0.005);
  g.gain.exponentialRampToValueAtTime(0.0001, t+0.05);
  o.start(t); o.stop(t+0.06);
  var o2 = audioCtx.createOscillator(); o2.type='triangle'; o2.frequency.value=140;
  var g2 = audioCtx.createGain(); g2.gain.value=0; o2.connect(g2).connect(audioCtx.destination);
  g2.gain.setValueAtTime(0, t);
  g2.gain.linearRampToValueAtTime(0.06*(vol||1), t+0.004);
  g2.gain.exponentialRampToValueAtTime(0.0001, t+0.07);
  o2.start(t); o2.stop(t+0.08);
}
function playWin(){
  if(!audioCtx) return;
  var now = audioCtx.currentTime;
  var seq = [880,1174.66,1567.98];
  seq.forEach(function(f,i){
    var o = audioCtx.createOscillator();
    var g = audioCtx.createGain();
    o.type='sine'; o.frequency.value=f; g.gain.value=0; g.connect(audioCtx.destination); o.connect(g);
    var t0 = now + i*0.08;
    g.gain.setValueAtTime(0, t0);
    g.gain.linearRampToValueAtTime(0.35, t0+0.03);
    g.gain.exponentialRampToValueAtTime(0.0001, t0+0.45);
    o.start(t0); o.stop(t0+0.5);
  });
}

// -------- Utils
var fmt;
try{ fmt = new Intl.NumberFormat('es-CO'); }catch(e){ fmt = {format:function(x){return String(x);}}; }
function setKPI(){ kpi.textContent = labels.length + ' l√≠neas'; }
function setCounter(){ lineCounter.textContent = 'N√∫mero de comentarios: ' + fmt.format(labels.length); }
function parseInput(){
  var raw = (ta.value || '').replace(/\r\n?/g,'\n');
  var lines = raw.split('\n'); var out = [];
  outer: for (var i=0;i<lines.length;i++){
    var parts = lines[i].split(/[;,\t]+/);
    for (var j=0;j<parts.length;j++){
      var p = parts[j].trim(); if(!p) continue;
      var m = p.match(/^(.*?)(?:\s*[xX]\s*(\d+))?$/);
      var name = (m ? m[1] : p).trim();
      var n = (m && m[2]) ? Math.min(LIMIT, Math.max(1, parseInt(m[2],10))) : 1;
      for (var k=0;k<n;k++){ out.push(name); if(out.length>=LIMIT) break outer; }
    }
  }
  return out;
}
function updatePreview(){
  labels = parseInput();
  setKPI();
  next.disabled = labels.length === 0;
  var freq = Object.create(null); for (var i=0;i<labels.length;i++){ var nm=labels[i]; freq[nm]=(freq[nm]||0)+1; }
  var arr = Object.keys(freq).map(function(nm){return {name:nm,c:freq[nm]};}).sort(function(a,b){return b.c-a.c;}).slice(0,12);
  previewList.innerHTML=''; if(!labels.length){ var it=document.createElement('div'); it.className='small'; it.textContent='No hay datos a√∫n.'; previewList.appendChild(it); return; }
  for (var i=0;i<arr.length;i++){ var d=document.createElement('div'); d.className='item'; var n=document.createElement('div'); n.textContent=arr[i].name; n.style.flex='1'; var t=document.createElement('div'); t.className='tag'; t.textContent='x'+arr[i].c; d.appendChild(n); d.appendChild(t); previewList.appendChild(d); }
}
ta.addEventListener('input', updatePreview);

// Canvas rueda (pre-render)
function sizeWheel(){
  var dpr = Math.max(1, window.devicePixelRatio||1);
  var side = Math.floor((document.querySelector('.canvas-wrap').clientWidth||680)*dpr);
  if (wheel.width !== side){ wheel.width=side; wheel.height=side; }
  return side;
}
var bitmap=null, bitmapSize=0;
function buildBitmap(){
  var px = sizeWheel(); bitmapSize = px;
  var off = document.createElement('canvas'); off.width=px; off.height=px; var o=off.getContext('2d');
  var W=px,H=px,cx=W/2,cy=H/2;
  var outerR = Math.min(cx,cy)*0.94;
  var innerR = Math.min(cx,cy)*0.28;
  var rimW = Math.max(2, Math.floor(px*0.012));
  o.clearRect(0,0,W,H);
  o.save(); o.translate(cx,cy);
  var n = Math.max(1, labels.length||1);
  if (n >= 300){
    var palette = ['#ff3b30','#34c759','#007aff','#ffcc00'];
    for (var i=0;i<n;i++){
      var ang = (i/n)*Math.PI*2;
      var col = palette[i % palette.length];
      o.beginPath();
      var x1 = Math.cos(ang)*innerR, y1 = Math.sin(ang)*innerR;
      var x2 = Math.cos(ang)*outerR, y2 = Math.sin(ang)*outerR;
      o.strokeStyle = col; o.lineWidth = Math.max(1, px*0.0012);
      o.moveTo(x1,y1); o.lineTo(x2,y2); o.stroke();
    }
    var ring = o.createRadialGradient(0,0,innerR*0.98, 0,0,outerR);
    ring.addColorStop(0, 'rgba(0,0,0,.25)'); ring.addColorStop(1, 'rgba(0,0,0,.08)');
    o.beginPath(); o.arc(0,0,outerR,0,Math.PI*2); o.arc(0,0,innerR,0,Math.PI*2,true); o.closePath();
    o.fillStyle = ring; o.fill();
  }else{
    var angPer = Math.PI*2/n, a=0;
    for (var i=0;i<n;i++){
      var a0=a, a1=a+angPer; a=a1;
      var g = o.createLinearGradient(0,-outerR,0,outerR);
      var base = ['#ff3b30','#34c759','#007aff','#ffcc00'][i%4];
      g.addColorStop(0, base); g.addColorStop(1,'rgba(0,0,0,.08)');
      o.beginPath(); o.moveTo(0,0); o.arc(0,0,outerR,a0,a1); o.closePath(); o.fillStyle=g; o.fill();
      o.strokeStyle='rgba(0,0,0,.25)'; o.lineWidth=Math.max(1, px*0.002);
      o.beginPath(); o.arc(0,0,outerR, a1-0.001, a1); o.stroke();
    }
    o.globalCompositeOperation='destination-out'; o.beginPath(); o.arc(0,0,innerR,0,Math.PI*2); o.fill(); o.globalCompositeOperation='source-over';
  }
  o.lineWidth = rimW; o.strokeStyle = '#2c2f36'; o.beginPath(); o.arc(0,0,outerR+rimW*0.5,0,Math.PI*2); o.stroke();
  o.globalCompositeOperation='destination-out'; o.beginPath(); o.arc(0,0,innerR,0,Math.PI*2); o.fill(); o.globalCompositeOperation='source-over';
  o.restore();
  bitmap = off;
}
function draw(){
  if (!bitmap || bitmapSize !== sizeWheel()) buildBitmap();
  var W=wheel.width,H=wheel.height,cx=W/2,cy=H/2;
  ctx.clearRect(0,0,W,H);
  ctx.save(); ctx.translate(cx,cy); ctx.rotate(rotation); ctx.drawImage(bitmap, -cx, -cy, W, H); ctx.restore();
}

// Fases
function toRoulette(){
  labels = parseInput(); setKPI(); setCounter();
  if(!labels.length){ alert('Pega al menos una l√≠nea'); return false; }
  buildBitmap(); rotation = 0; draw();
  setup.setAttribute('aria-hidden','true');
  roulette.setAttribute('aria-hidden','false');
  window.scrollTo({top:0, behavior:'smooth'});
  return true;
}
function backToSetup(){
  roulette.setAttribute('aria-hidden','true');
  setup.setAttribute('aria-hidden','false');
  window.scrollTo({top:0, behavior:'smooth'});
}

// Instagram helpers
function extractInstagramHandle(text){
  if (!text) return null;
  text = String(text).trim();
  // Quitar trailing slash y espacios
  text = text.replace(/\/+$/,'').trim();
  // URL completa
  var m = text.match(/instagram\.com\/([A-Za-z0-9._]+)/i);
  if (m && m[1]) return m[1];
  // @usuario
  m = text.match(/@([A-Za-z0-9._]+)/);
  if (m && m[1]) return m[1];
  // si es s√≥lo el handle sin @ ni url y no contiene espacios
  if (/^[A-Za-z0-9._]+$/.test(text)) return text;
  return null;
}
var PLACEHOLDER = 'data:image/svg+xml;utf8,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="110" height="110" viewBox="0 0 110 110"><rect width="110" height="110" rx="55" fill="#f0f2f7"/><text x="55" y="58" font-size="32" text-anchor="middle" fill="#9aa0a6">üë§</text></svg>');
function setAvatarFor(name){
  var handle = extractInstagramHandle(name);
  if(!handle){ avatarEl.src = PLACEHOLDER; return; }
  var url = 'https://unavatar.io/instagram/' + encodeURIComponent(handle) + '?fallback=true';
  avatarEl.onerror = function(){ avatarEl.onerror = null; avatarEl.src = PLACEHOLDER; };
  avatarEl.src = url;
}

// Giro
function easeOutCubic(t){ return 1 - Math.pow(1-t,3); }
function spin(){
  if (spinning) return;
  if (!labels.length){ if(!toRoulette()) return; }
  ensureAudio();
  spinning = true;
  var n = Math.max(1, labels.length);
  var idx = Math.floor(Math.random()*n);
  var ang = ((idx + 0.5)/n)*Math.PI*2;
  var jitter = (Math.random()-0.5)*(Math.PI*2/n*0.2);
  var target = -(ang + jitter);
  var extra = 10;
  var start = rotation;
  var finalRot = start + target + extra*(Math.PI*2);

  bar.style.transition='none'; bar.style.width='0%';
  requestAnimationFrame(function(){ bar.style.transition='width '+duration+'ms linear'; bar.style.width='100%'; });

  var t0 = performance.now();
  var lastTick = t0;
  function frame(now){
    var t = Math.min(1, (now - t0)/duration);
    var k = easeOutCubic(t);
    rotation = start + (finalRot - start)*k;
    draw();

    var interval = 25 + 195*Math.pow(t, 0.7);
    if (now - lastTick >= interval){
      var vol = 0.9 - 0.6*t;
      playTick(vol);
      lastTick = now;
    }

    if(t<1){ requestAnimationFrame(frame); } else { onStop(labels[idx]); }
  }
  requestAnimationFrame(frame);
}

function onStop(name){
  spinning=false;
  playWin();
  setAvatarFor(name);
  winEl.textContent = name;
  modal.classList.add('show');
  bar.style.transition='none'; bar.style.width='0%';
}

// Eventos
previewBtn.addEventListener('click', updatePreview);
ta.addEventListener('input', updatePreview);
next.addEventListener('click', toRoulette);
back.addEventListener('click', backToSetup);
spinBtn.addEventListener('click', spin);
centerBtn.addEventListener('click', spin);
centerBtn.addEventListener('keydown', function(e){ if(e.key==='Enter' || e.key===' ' || e.code==='Space'){ e.preventDefault(); spin(); }});
closeBtn.addEventListener('click', function(){ modal.classList.remove('show'); });

secBtns.forEach(function(b){ b.addEventListener('click', function(){ secBtns.forEach(function(x){x.removeAttribute('aria-pressed');}); b.setAttribute('aria-pressed','true'); duration = Math.max(800, parseInt(b.dataset.sec,10)*1000); }); });
window.addEventListener('resize', function(){ bitmap=null; draw(); });

// Init demo
ta.value = "@beufryc\n@stevemx_\nusuario_simple\nhttps://www.instagram.com/beufryc/";
updatePreview();
})();</script>
</body>
</html>
